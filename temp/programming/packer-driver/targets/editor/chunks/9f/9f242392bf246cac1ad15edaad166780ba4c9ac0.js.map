{"version":3,"sources":["file:///Users/playgendary/wn/1/test_rockstone/assets/scripts/FieldWatcher.ts"],"names":["_decorator","Component","Node","SpriteFrame","Sprite","director","Vec2","instantiate","Prefab","Events","Item","ccclass","property","FieldWatcher","_sideSquare","_fieldArray","onLoad","makeCells","makeItems","inputCatcher","active","onEnable","handleSubscription","onDisable","activated","func","ItemChosen","onItemChosen","ItemDropped","onItemDropped","item","newNumbers","defineCell","getPosition","newItemPosition","node","getChildByName","y","x","position","emit","ItemSet","fusionItems","defineNumbers","i","heightField","needingIndex","indexOf","defineCellPosition","itemNumbers","itemPosition","numberColumn","Math","floor","lengthField","numberStroke","numeralItems","initialItems","length","newItem","itemPrefab","itemScript","getComponent","type","setType","numbers","chooseNumbers","zeroCell","deltaX","deltaY","setParent","newPositionNode","setPosition","spriteCell","height","j","newCell","addComponent","spriteFrame","set","movedItem","previousItem","oldNumbers","previousItemScript","movedItemScript","dropItem","transformationItem","numbersCopy","findFreeCell","transferItem","random","distance","currentDistance","sqrt","pow"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, SpriteFrame, Sprite, director, Vec3, Vec2, instantiate, Prefab, Enum } from 'cc';\nconst { ccclass, property } = _decorator;\n\nimport ItemType from './ItemType';\nimport Events from './Events';\nimport { Item } from './Item';\n\n@ccclass('FieldWatcher')\nexport class FieldWatcher extends Component {\n    @property\n    private lengthField: number = 3;\n    @property\n    private heightField: number = 2;\n    @property(SpriteFrame)\n    private spriteCell: SpriteFrame = null;\n\n    @property(Node)\n    private inputCatcher: Node = null;\n\n    @property(Prefab)\n    private itemPrefab: Prefab = null;\n\n    // @property({ type: Enum(ItemType) })\n    // private initialItems;\n\n    private _sideSquare: number = 0;\n\n    private _fieldArray: Array<Array<Node>> = [];\n\n    onLoad() {\n        this.makeCells();\n        this.makeItems();\n        this.inputCatcher.active = false;\n    }\n\n    onEnable() {\n        this.handleSubscription(true);\n    }\n\n    onDisable() {\n        this.handleSubscription(false);\n    }\n\n    private handleSubscription(activated) {\n        const func = activated ? 'on' : 'off';\n        director[func](Events.ItemChosen, this.onItemChosen, this);\n        director[func](Events.ItemDropped, this.onItemDropped, this);\n    }\n\n    onItemDropped(item: Node) {\n        let newNumbers = this.defineCell(item.getPosition());\n        const newItemPosition = this.node.getChildByName(`h${newNumbers.y}l${newNumbers.x}`).position;\n        director.emit(Events.ItemSet, newItemPosition);\n        this.fusionItems(item, newNumbers);\n    }\n\n    private defineNumbers(item: Node): Vec2 {\n        for (let i = 0; i < this.heightField; i++) {\n            const needingIndex = this._fieldArray[i].indexOf(item);\n            if (needingIndex !== -1) return new Vec2(needingIndex, i);\n        }\n    }\n\n    onItemChosen() {\n        this.inputCatcher.active = true;\n    }\n\n    private defineCellPosition(itemNumbers: Vec2): Vec3 {\n        return this.node.getChildByName(`h${itemNumbers.y}l${itemNumbers.x}`).position;\n    }\n\n    private defineCell(itemPosition: Vec3): Vec2 {\n        const numberColumn = Math.floor(itemPosition.x / this._sideSquare + this.lengthField / 2 - 1) + 1;\n        const numberStroke = Math.floor(itemPosition.y / this._sideSquare + this.heightField / 2 - 1) + 1;\n        return new Vec2(numberColumn, numberStroke);\n    }\n\n    private makeItems() {\n        const numeralItems = this.initialItems.length;\n        for (let i = 0; i < numeralItems; i++) {\n            const newItem = instantiate(this.itemPrefab);\n            const itemScript = newItem.getComponent(Item);\n            itemScript.type = this.initialItems[i];\n            itemScript.setType(itemScript.type);\n            const numbers = this.chooseNumbers();\n            const zeroCell = this.node.getChildByName('h0l0').position;\n            itemScript.deltaX = -zeroCell.x;\n            itemScript.deltaY = -zeroCell.y;\n            newItem.setParent(this.node);\n            const newPositionNode = this.node.getChildByName(`h${numbers.y}l${numbers.x}`);\n            newItem.setPosition(newPositionNode.position);\n            this._fieldArray[numbers.y][numbers.x] = newItem;\n        }\n    }\n\n    private makeCells() {\n        this._sideSquare = this.spriteCell.height;\n        if (this.lengthField && this.heightField && this.spriteCell) {\n            for (let i = 0; i < this.heightField; i++) {\n                this._fieldArray[i] = [];\n                for (let j = 0; j < this.lengthField; j++) {\n                    this._fieldArray[i][j] = null;\n                    const newCell = new Node(`h${i}l${j}`);\n                    const spriteCell = newCell.addComponent(Sprite);\n                    spriteCell.spriteFrame = this.spriteCell;\n                    newCell.setParent(this.node);\n                    newCell.position.set(\n                        (j - this.lengthField / 2 + 0.5) * this._sideSquare,\n                        (i - this.heightField / 2 + 0.5) * this._sideSquare\n                    );\n                }\n            }\n        }\n    }\n\n    private fusionItems(movedItem: Node, numbers: Vec2): void {\n        const previousItem = this._fieldArray[numbers.y][numbers.x];\n        if (previousItem === movedItem) return;\n        let newItem = movedItem;\n        const oldNumbers = this.defineNumbers(movedItem);\n        if (previousItem) {\n            const previousItemScript = previousItem.getComponent(Item);\n            const movedItemScript = movedItem?.getComponent(Item);\n            if (previousItemScript.type === movedItemScript.type) {\n                previousItemScript.dropItem();\n                movedItemScript.transformationItem(previousItemScript.type + 1);\n            } else {\n                const numbersCopy = numbers;\n                numbers = this.findFreeCell(numbers, movedItem);\n                previousItemScript.transferItem(this.defineCellPosition(numbers));\n                this._fieldArray[numbersCopy.y][numbersCopy.x] = newItem;\n                newItem = previousItem;\n            }\n        }\n        this._fieldArray[oldNumbers.y][oldNumbers.x] = null;\n        this._fieldArray[numbers.y][numbers.x] = newItem;\n    }\n\n    private chooseNumbers(): Vec2 {\n        let numbers = new Vec2(0, 0);\n        while (this._fieldArray[numbers.y][numbers.x] !== null) {\n            numbers = new Vec2(\n                Math.floor(Math.random() * this.lengthField),\n                Math.floor(Math.random() * this.heightField)\n            );\n        }\n        return numbers;\n    }\n\n    private findFreeCell(numbers: Vec2, item: Node): Vec2 {\n        let newNumbers = new Vec2(this.lengthField * this.heightField, 0);\n        let distance = this.heightField * this.lengthField;\n        for (let i = 0; i < this.heightField; i++) {\n            for (let j = 0; j < this.lengthField; j++) {\n                if (!this._fieldArray[i][j] || this._fieldArray[i][j] === item) {\n                    const currentDistance = Math.sqrt(Math.pow(numbers.y - i, 2) + Math.pow(numbers.x - j, 2));\n                    if (currentDistance < distance) {\n                        distance = currentDistance;\n                        newNumbers = new Vec2(j, i);\n                    }\n                }\n            }\n        }\n        return newNumbers;\n    }\n}\n"]}